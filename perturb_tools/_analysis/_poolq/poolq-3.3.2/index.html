<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>PoolQ 3.0 Manual</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      word-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h1 id="poolq">PoolQ</h1>
<p>PoolQ is a counter for indexed samples from next-gen sequencing of pooled DNA.</p>
<p><em>This documentation covers PoolQ version 3.3.1 (last updated 01/27/2021).</em></p>
<h2 id="background">Background</h2>
<p>The Broad Institute Genetic Perturbation Platform (GPP) uses Illumina sequencing to tally the results of pooled screens. PoolQ can process pooled screens representing a variety of genetic perturbation techniques, including CRISPR/Cas9, RNAi, and barcoded ORFs. We perform the following steps to generate one or more files of sequencing reads (or “reads files”) for the pooled screen:</p>
<ol type="1">
<li>We start with multiple genomic DNA samples; generally it is assumed that the samples share a common pool of constructs but vary by some experimental condition.</li>
<li>We apply PCR to the genomic DNA samples using primers that amplify the the barcode region of each construct in the pool and attach a fixed-length barcode uniquely identifying the DNA sample. In this way, all the amplification products will contain the inserted sample barcode.</li>
<li>We pool all the samples, normalized to equalize barcode representation, and run them in a single sequencing lane.</li>
<li>The sequencing process generates an output file for each sequencing lane.</li>
</ol>
<p>PoolQ comes into play after the sequencing files have been generated. A single PoolQ invocation processes one sequencing run. It attempts to parse out the unique barcodes representing the sample and construct from each read. It maps sample barcodes to conditions and construct barcodes to construct IDs, and generates a matrix with the conditions as columns and the constructs as rows.</p>
<h2 id="changes-in-poolq-3.0">Changes in PoolQ 3.0</h2>
<p>PoolQ was completely rewritten for version 3.0. The new code is faster and the codebase is much cleaner and more maintainable. We have taken the opportunity to make other changes to PoolQ as well.</p>
<ul>
<li>There are substantial changes to the command-line interface for the program.</li>
<li>The default counts file format has changed slightly, although there is a command-line argument that indicates that PoolQ 3.0 should write a backwards-compatible counts file. The differences are in headers only; file parsers should be able to adapt easily.</li>
<li>The quality file has changed somewhat. Importantly, the definition of certain statistics has changed slightly, so quality metrics cannot be directly compared between the the new and old versions. In addition, we no longer provide normalized match counts.</li>
</ul>
<h3 id="command-line-interface-changes">Command-line interface changes</h3>
<p>The PoolQ command-line interface has been reworked significantly in PoolQ 3.0. There is no current migration guide between the two interfaces; however virtually every possible configuration of PoolQ 2.0 is also possible with PoolQ 3.0. To update your command-line arguments, consult the commands specified in the test data <code>Makefile</code> for each scenario. Furthermore, there are extensive explanations of the various parameters in subsequent sections of this document.</p>
<h3 id="counts-file-changes">Counts file changes</h3>
<p>One of the key internal changes to PoolQ 3.0 was to avoid using the terms “construct barcode” and “sample” barcode prescriptively. PoolQ 3.0 favors the terms <em>row barcode</em> and <em>column barcode</em>, since the actual concepts these barcodes represent should be of limited concern to PoolQ. As such, the default counts file format changes its terminology slightly. Where the PoolQ 2.X counts file header read:</p>
<pre><code>ConstructBarcode        Construct IDs</code></pre>
<p>the PoolQ 3.0 counts file header reads:</p>
<pre><code>Row Barcode             Row Barcode IDs</code></pre>
<p>Note that the structure of the files have not changed, so any parser which ignores these columns in the header need not make any changes. Parsers that use these columns should be able to adapt trivially to the new terminology. Moreover, PoolQ 3.0 supports a command line option <code>--compat</code> which specifies that the counts file contain the former terminology.</p>
<h3 id="quality-file-changes">Quality file changes</h3>
<ul>
<li>Changed the “Total Reads” metric to report the total number of reads in the file i.e., do not discard reads with Ns in the column (conditions) barcode region. These values will be higher in PoolQ 3 than they would have been previously for the same input data.</li>
<li>Changed the “Matching Reads” metric to include only reads that matched both a known row and column barcode; formerly this number included all reads that matched a row barcode even if they did not match a column barcode. These values will be lower in PoolQ 3 than they would have been previously for the same input data.</li>
<li>Changed the “1-base mismatch reads” metric to report the number of one-base mismatches used to match a row barcode only if the column barcode also matched; as above, this formerly included reads that matched a row barcode even if the column barcode did not match. These values will be lower in PoolQ 3 than they would have been previously for the same input data.</li>
<li>Changed the “Overall % Match: (Construct+Sample Barcode)/total reads” heading to simply “Overall % match”, and report the % as the number of reads matching both a row and column barcode divided by the total number of reads in the file (i.e., do not exclude reads with Ns in the column barcode region from the denominator). These values will be lower in PoolQ 3 than they would have been previously for the same input data.</li>
<li>In the section “Read counts for sample barcodes with associated conditions”, changed “Matched Sample Barcode” and “% Match” to count reads where the column barcode matched and where a row barcode region was identified (either by locating a search prefix, matching to a template, or a row barcode start index). This excludes reads created by primer-dimers and other PCR or sequencing errors. Number of matched column barcodes will generally be lower than with PoolQ 2, but the percent matched will be higher, for the same input data.</li>
<li>Removed the metric “Avg. counts for unknown sample barcodes”</li>
<li>Changed the “Read counts for sample barcodes without associated conditions” metric to be specific to cases where a row barcode matched but a column barcode did not; report only the top 100 unexpected column barcodes.</li>
<li>Removed the “Construct barcodes matching multiple construct IDs” section</li>
</ul>
<h2 id="poolq-use-cases">PoolQ Use Cases</h2>
<p>The most common usages of PoolQ falls into one of six basic scenarios, defined by the number of sequencing files it needs to read and the way it will locate barcodes within those files. PoolQ can process sequencing results with reads wholly contained within one sequencing file, or with each read partially represented within two sequencing files. It can locate barcodes that occur at a constant offset within the reads or that occur at a variable offset within the reads. For barcodes whose position varies within the reads, PoolQ has two approaches for identifying the barcode region: first, by locating a fixed DNA sequence known to immediately precede the row barcode; and second, by tiling a template sequence along the read until a sequence of DNA matches the template.</p>
<p>We describe the combination of these two dimensions in the following way:</p>
<ul>
<li>Scenario 1: Fixed offset, one sequencing file</li>
<li>Scenario 2: Variable offset, one sequencing file</li>
<li>Scenario 3: Fixed offset, two sequencing files</li>
<li>Scenario 4: Variable offset, two sequencing files</li>
<li>Scenario 5: Template match, one sequencing file</li>
<li>Scenario 6: Template matching, two sequencing files</li>
</ul>
<p>These scenarios require different command-line options. The PoolQ distribution contains sample data representing each scenario and presents example command lines for processing each case.</p>
<h2 id="poolq-inputs">PoolQ Inputs</h2>
<p>PoolQ requires 3 input files to run: the (FASTQ or SAM/BAM) file containing the reads (the reads file); a file mapping barcodes to conditions (the conditions file); and a file mapping row barcode sequences to barcode IDs (the reference file). PoolQ can also take an optional input file (the platform reference file) describing known row barcodes that are not expected to be present in the sequencing reads. There are also a variety of optional settings that specify how PoolQ processes the reads.</p>
<h3 id="reads-files">Reads File(s)</h3>
<p>The reads file is a either a standard FASTQ file or a SAM/BAM file, containing the reads. It may or may not be compressed with gzip. If the file is a FASTQ file, then the file extension should be <code>.fastq</code> or <code>.txt</code> (case-insensitive). If it is a BAM file, then the file extension should be <code>.bam</code>, and for a SAM file, the extension should be <code>.sam</code> (case-insensitive). Files that do not follow these naming conventions can still be used, but you must specify the file type explicitly.</p>
<p>If the file is compressed with gzip, then the file must have an extra <code>.gz</code> extension after the <code>.fastq</code>, <code>.txt</code>, or <code>.bam</code> extension.</p>
<p>A barcode representing a row and a column are parsed out of each read. The length of the column barcode is inferred from the contents of the conditions file. The length of the row barcode is inferred from the contents of the reference file. By default, the column barcode starts at the first base of the read, and the row barcode starts at the 17th base of the read, but both of these defaults can be overridden with an optional flag.</p>
<p>In some cases, reads are divided into two separate FASTQ files (BAM/SAM is not supported in this case). One file contains the column barcodes, while the other contains the row barcodes. In this case, the file with shorter reads is assumed to contain the column barcodes, while the file with longer reads is assumed to contain the row barcodes. This mode of operation requires that FASTQ record IDs match between the two input files.</p>
<h3 id="reference-files">Reference Files</h3>
<p>Reference files map DNA barcodes to their associated identifiers. PoolQ uses two reference files to define the rows and columns found in the counts file.</p>
<h4 id="column-reference-file">Column Reference File</h4>
<p>The column reference file (formerly known as the “conditions” file) maps DNA barcodes to the IDs that will be presented as the columns in the counts files. Generally the columns correspond to sample barcodes, which identify unique gDNA samples representing different experimental conditions.</p>
<ul>
<li>It is a file with at least two columns</li>
<li>The first column contains the barcode sequence and the second column contains the condition description</li>
<li>All other columns are ignored</li>
<li>Every row must have the same number of columns</li>
<li>The columns can be separated by either commas or tabs</li>
<li>The file may not include any column headers or any extra columns</li>
<li>Barcodes must contain only A, T, C or G</li>
<li>A barcode cannot occur more than once in the file</li>
<li>Every barcode in the conditions file must have the same length</li>
<li>You can have multiple barcodes mapping to the same condition, but be aware that if you do so, the reads for those barcodes will be counted together, resulting in a single column in the counts file for that condition</li>
</ul>
<h4 id="row-reference-file">Row Reference File</h4>
<p>The row reference file (formerly simple the “reference file”) contains the DNA barcodes that will make up the rows in the counts file. Generally, the rows correspond to barcodes representing shRNAs, sgRNAs, ORFs, or other constructs utilized in a pooled experiment.</p>
<ul>
<li>It is a file with at least two columns</li>
<li>The first column contains the barcode sequences, and the second column contains the barcode IDs</li>
<li>All other columns are ignored</li>
<li>Every row must have the same number of columns</li>
<li>The columns can be separated by either commas or tabs</li>
<li>The file may not include any column headers or any extra columns</li>
<li>Barcode sequences must contain only A, T, C or G</li>
<li>A barcode ID cannot occur more than once in the file</li>
<li>Every barcode in the reference file must have the same length</li>
<li>You can have multiple IDs mapping to the same barcode sequence; the counts file will report the counts for the barcode alongside a comma-separated list of associated IDs.</li>
</ul>
<h4 id="platform-reference-file">Platform Reference File</h4>
<p>The platform reference file is an optional input file whose format is identical to that of the reference file. It consists of a master list of known construct sequences and their construct IDs. This file is used to provide construct IDs for barcodes encountered during the PoolQ run that were not expected to occur. A construct is expected to occur only if it is present in the reference file.</p>
<h3 id="umi-barcode-reference-file">UMI Barcode Reference File</h3>
<p>The UMI barcode reference file contains information about unique molecular identifier (UMI) barcodes that may optionally be located within the reads. Unlike other reference files, UMI reference files list DNA barcodes only. No barcode identifiers will be parsed from the UMI reference file. As with other reference files, the UMI barcodes must contain only A, C, G, or T and they must all have the same length. Duplicate barcodes are ignored.</p>
<h3 id="row-matcher">Row Matcher</h3>
<p>This argument determines how PoolQ matches DNA barcodes to those in its row reference database. There are currently two supported values, “exact” and “mismatch”. Using “exact” requires every base to match perfectly; “mismatch” allows up to one base of mismatch between them (no gaps or deletions allowed).</p>
<h3 id="column-matcher">Column Matcher</h3>
<p>This argument determines how PoolQ matches DNA barcodes to those in its column reference database. There are currently two supported values, “exact” and “mismatch”. Using “exact” requires every base to match perfectly; “mismatch” allows up to one base of mismatch between them (no gaps or deletions allowed).</p>
<h3 id="barcode-policy">Barcode policy</h3>
<p>Barcode policies indicate how PoolQ should locate various types of barcodes in the reads. PoolQ supports 3 basic policies: fixed-location, search prefix, template. Barcode policies may be specified to locate row, column, and UMI barcodes.</p>
<h5 id="fixed-location">Fixed Location</h5>
<p>The fixed-location policy indicates that a barcode exists at a single, known position within the read. For a 0-based index <code>i</code>, you can specify a fixed strategy by passing <code>FIXED@i</code>. So a barcode located at the start of the read is specified as <code>FIXED@0</code>, while a barcode located at the twelfth base into the read is specified <code>FIXED@11</code>. Using the fixed location policy, you can optionally specify how many bases to read as the barcode (sometimes reads are too short to contain a full barcode). The length <code>n</code> is specified by adding <code>:n</code> to the end of the policy; so the policy for finding a 6-base barcode twelve bases into the read is specified as <code>FIXED@11:6</code>. If you do not specify a length, PoolQ will choose the length based on the length of barcodes found in the corresponding reference file.</p>
<h5 id="search-prefix">Search Prefix</h5>
<p>The search prefix policy is useful when barcodes may occur at different positions within each read, assuming the barcode region is always immediately preceded by some known DNA sequence. When specifying a prefix policy, you must provide the prefix that PoolQ should look for. Optionally, you can provide additional parameters specifying a range of bases where the search prefix could occur within the read; as with the fixed location policy, you may also give a barcode length.</p>
<p>To use the prefix policy for a DNA prefix <code>s</code>, specify <code>PREFIX:s</code>. For example, a common DNA prefix is <code>CACCG</code>, which is specified <code>PREFIX:CACCG</code>. To indicate that the prefix should only be located beginning at the 12th base of the read, specify <code>PREFIX:CACCG@11</code>. To indicate that the prefix must occur before the 20th base of the read, specify <code>PREFIX:CACCG@-19</code>. These two parameters may be specified in conjunction: <code>PREFIX:CACCG@11-19</code>. You can optionally specify how many bases to read as the barcode (sometimes reads are too short to contain a full barcode). The length <code>n</code> is specified by adding <code>:n</code> to the end of the policy; so the policy for finding a 6-base barcode twelve bases into the read is specified as <code>PREFIX@11-19:6</code>. If you do not specify a length, PoolQ will choose the length based on the length of barcodes found in the corresponding reference file.</p>
<h5 id="template">Template</h5>
<p>The template matching policy is useful when barcodes may occur at different positions from read to read, but the barcode can be identified by examining the surrounding context. Template matching also allows for the possibility that barcodes are not made up of contiguous regions. Templates are specified using IUPAC codes in upper- and lowercase. Lowercase bases are used in matching, but are not extracted as part of the barcode. Uppercase bases are used in matching <em>and</em> are extracted as part of the barcode. For example the template: <code>caccgNNNNctcnnnNNNNa</code> indicates that we are looking for a 20-base region that: * begins with <code>CACCG</code> * followed by the first four bases of the barcode * then the sequence <code>CTC</code>, * then three more arbitrary bases * followed by the next four bases of the barcode * then a single <code>A</code> Given the read sequence <code>TTGCACCGTTGTCTCATGACCTATGTG</code>, notice that the template <code>caccgNNNNctcnnnNNNNa</code> matches only at the 4th base (indicated <code>3</code> on the ruler)</p>
<pre><code>0         1         2
012345678901234567890123456
TTGCACCGTTGTCTCATGACCTATGTG
   caccgNNNNctcnnnNNNNa</code></pre>
<p>The barcode that will be extracted is <code>TTGTACCT</code>.</p>
<p>To indicate that PoolQ should search for barcodes using a template <code>t</code>, specify <code>TEMPLATE:t</code>. For example, to use the template <code>caccgNNNNctcnnnNNNNa</code>, give <code>TEMPLATE:caccgNNNNctcnnnNNNNa</code>. As with the search prefix policy, it is possible to limit where PoolQ searches within each read for template matches. To indicate that the template should only be located beginning at the 12th base of the read, specify <code>TEMPLATE:caccgNNNNctcnnnNNNNa@11</code>. To indicate that the prefix must occur before the 20th base of the read, specify <code>TEMPLATE:caccgNNNNctcnnnNNNNa@-19</code>. These two parameters may also be specified in conjunction: <code>TEMPLATE:caccgNNNNctcnnnNNNNa@11-19</code>. Unlike with the fixed-location and prefix search policies, you cannot limit the length of the matched barcode.</p>
<h4 id="row-barcode-policy">Row Barcode Policy</h4>
<p>The row barcode policy specifies how row barcodes are located. For details on barcode policies, see the previous section.</p>
<h4 id="column-barcode-policy">Column Barcode Policy</h4>
<p>The column barcode policy specifies how column barcodes are located. For details on barcode policies, see the previous section.</p>
<h4 id="umi-barcode-policy">UMI Barcode Policy</h4>
<p>The UMI barcode policy specifies how UMI barcodes are located. When reads are split between two files, PoolQ will search for UMI barcodes in the same file/read that it uses to locate row barcodes.</p>
<h3 id="count-ambiguous">Count Ambiguous</h3>
<p>This is an optional input flag that, when present, controls the handling of barcodes encountered in reads that fuzzy-match to more than one barcode in the reference file. The default behavior is to discard ambiguously matching reads, so they will not be included in the counts file. If this behavior is not desired, specify this flag and all ambiguous reads will be counted for every possible matching row barcode. As a consequence of this behavior, the sum of the counts for a given column may add up to more than the number of reads for a particular condition.</p>
<h3 id="unexpected-sequence-threshold">Unexpected Sequence Threshold</h3>
<p>This is an optional argument that, when present, specifies the number of unexpected barcodes to include in the unexpected sequence report. PoolQ will report the most frequently occurring barcodes. The default value is 100.</p>
<h3 id="reads-file-type">Reads File Type</h3>
<p>This is an optional input flag that, when present, specifies how PoolQ should treat the reads file type. By default, PoolQ will attempt to guess whether the reads file is a FASTQ, BAM, or text file based on the file name. If the filename is misleading, you can specify the file type explicitly using this flag. Valid values include BAM, FASTQ, and RAW (for plain text).</p>
<h3 id="skip-short-reads">Skip Short Reads</h3>
<p>This is an optional input flag that, when present, specifies that PoolQ should simply ignore reads that are too short to contain both barcode sequences. By default, PoolQ considers files containing short reads to be badly formed and exits. By specifying this flag, you indicate that PoolQ should simply skip these short reads; a count of the number of skipped short reads will be available in the quality file. Currently, this flag is only supported if you have selected the fixed barcode policy.</p>
<h3 id="always-match-column-barcodes">Always Match Column Barcodes</h3>
<p>This is an advanced, optional input flag that, when present, specifies how PoolQ should count the total number of reads found matching each column barcode, which is reported in the quality file. The default behavior is to count column barcodes that match to the column reference file only if a row barcode was successfully located in the read as well (even if that row barcode did not match to a barcode in the row reference file). With this setting enabled, PoolQ counts column barcodes regardless of whether a row barcode was found or not. This metric can be useful for certain types of analyses.</p>
<h3 id="compatibility-mode">Compatibility mode</h3>
<p>This is an optional input flag that, when present, specifies that PoolQ should write counts files that are identical to those emitted by PoolQ 2.0. As described above, the difference is in the header text. This flag is provided to make comparing counts between PoolQ 2.0 and PoolQ 3.0 easier, and to support users who parse counts files as part of their processing pipelines. This option is mutually exclusive of the GCT mode.</p>
<h3 id="gct-mode">GCT mode</h3>
<p>This is an optional flag that directs PoolQ to emit counts in the <a href="GCT">http://software.broadinstitute.org/cancer/software/genepattern/file-formats-guide#GCT</a> file format, for use with tools such as GenePattern or RIGER. It is mutually exclusive of the PoolQ 2.0 compatibility mode flag described above.</p>
<h2 id="poolq-outputs">PoolQ Outputs</h2>
<p>PoolQ generates output files representing the matrix of read counts (or counts) for expected sequences, a report of read counts for unexpected sequences, and a report containing simple metrics used to help assess the overall quality of the sequencing data. There are two optional output files that contain alternative representations of the counts matrix. One contains the counts in log normalized form and the other contains read counts by barcode rather than by condition.</p>
<h3 id="counts-file">Counts File</h3>
<p>The counts file is a text file that contains a simple matrix of the read counts. The columns of the matrix represent the experimental conditions, and the rows of the matrix correspond the row barcode sequences. The individual values in each row are separated by tabs.</p>
<p>If you plan on loading the counts file into a spreadsheet application such as Excel, then we recommend using a file extension such as <code>.txt</code>, that your spreadsheet application will recognize as being a text file. When opening the file in Excel, you will probably be prompted with a dialog asking you to describe the structure of the file. In the section about separator options, be sure that the checkbox for “Tab” is selected.</p>
<h3 id="quality-report">Quality Report</h3>
<p>The quality report is a simple text file containing some extra information gathered during the PoolQ run. The information reported here is intended to help you assess the quality of your data, and spot problems such as an unacceptably high frequency of uncounted reads, or mistakes in barcode tracking. We currently report:</p>
<ul>
<li>The total number of reads</li>
<li>The total number of reads that were successfully counted</li>
<li>Out of the counted reads, the total number of single base mismatches to the row barcode</li>
<li>Out of the counted reads, the percent that matched to both a known column barcode and a known row barcode</li>
<li>The average frequency of unknown column barcode sequences</li>
<li>For each column barcode mapped to a condition, we report:
<ul>
<li>the barcode</li>
<li>the condition</li>
<li>the total number of reads matching the column barcode plus an expected row barcode</li>
<li>the total number of reads matching the column barcode <em>and</em> containing a valid row barcode region (by either containing a search prefix, matching the search template, or the row barcode start index); when run with <code>--always-count-col-barcodes</code>, this is simply the total number of reads matching that column barcode</li>
<li>the percent of reads for the column barcode with a valid row barcode region that successfully matched a row barcode in the reference file</li>
<li>the log normalized number of matches</li>
</ul></li>
<li>For each column barcode not mapped to a condition, we report the barcode and the total number of reads</li>
</ul>
<h3 id="barcode-counts-file">Barcode Counts File</h3>
<p>The barcode counts file has a similar format to the counts file, except that the columns in the matrix represent the read counts for individual DNA barcodes rather than for experimental conditions. If, based on the quality file, a particular PCR appear to have been of low quality, it is possible to reaggregate counts by condition by excluding the counts from the barcode corresponding to the failed PCR. The barcode counts file is an optional output intended to provide support for loading PoolQ data into the RNAi Informatics database. However, it is available for any consumer of PoolQ data.</p>
<h3 id="log-normalized-counts-file">Log Normalized Counts File</h3>
<p>The log normalized counts file has the same format as the counts file, but every score is normalized according to the following procedure:</p>
<ol type="1">
<li>Take the raw read count for the row barcode ID and the condition</li>
<li>Divide by the total number of reads for that condition that matched a barcode found in a reference file</li>
<li>Multiply by a constant factor of 1 million</li>
<li>Add one</li>
<li>Take the log base 2</li>
</ol>
<h3 id="unexpected-sequence-file">Unexpected Sequence File</h3>
<p>The unexpected sequence file contains a report that describes briefly the collection of sequences found in the position where a row barcode was expected during the run. It is an optional output. Tracking unexpected sequences currently results in a substantial performance penalty. We recommend that you only generate an unexpected sequence for forensic or investigative purposes.</p>
<p>The unexpected sequence report contains two sections. The first section consists of a table whose rows correspond to unexpected row barcode sequences and whose columns indicate the number of times each sequence was found for each barcode. An additional column lists the barcode IDs for these sequences, if the IDs are known. These row barcode IDs can be provided to PoolQ via the platform reference file, described above.</p>
<p>The second section describes unexpected column barcodes and the number of times an unexpected sequence appeared with each unexpected barcode. The unexpected column barcodes are listed in descending order of the number of occurrences.</p>
<h3 id="correlation-file">Correlation File</h3>
<p>The correlation file contains a pairwise correlation matrix comparing the per-row barcode counts for each experimental condition. The correlation metric is the Pearson product-moment correlation.</p>
<h3 id="umi-quality-file">UMI Quality file</h3>
<p>When running in UMI mode, PoolQ writes a UMI quality file, which lists the read counts for expected UMI barcodes as well as the top 100 unexpected UMI barcodes (along with their frequencies). Expected UMI barcodes are listed in lexicographical order (eg, <code>AAAAAA</code> to <code>TTTTTT</code>). Unexpected UMI barcodes are listed in descending order by frequency.</p>
<h3 id="umi-counts-directory">UMI Counts Directory</h3>
<p>When running in UMI mode, PoolQ may generate a large number of counts files. To make file management easier, PoolQ allows the user to specify a directory where the UMI-barcoded counts files will be written. If this option is not specified, the default is to make a directory called <code>umi-counts</code> and place the UMI-barcoded counts files there.</p>
<h3 id="umi-barcode-counts-directory">UMI Barcode Counts Directory</h3>
<p>When running in UMI mode, PoolQ may generate a large number of barcode counts files. To make file management easier, PoolQ allows the user to specify a directory where the UMI-barcoded barcode counts files will be written. If this option is not specified, the default is to make a directory called <code>umi-barcode-counts</code> and place the UMI-barcoded barcode counts files there.</p>
<h2 id="running-poolq">Running PoolQ</h2>
<p>PoolQ currently is a Java application with a command-line interface (CLI). But before you can run it, you need to download the zip file and unzip it.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>PoolQ is built for Java 8. To run PoolQ, you will need a JRE for version 8 or later. To compile PoolQ you will need a Java 8 JDK. You can download an appropriate JRE or JDK from Oracle at:</p>
<blockquote>
<p><a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">http://www.oracle.com/technetwork/java/javase/downloads/index.html</a></p>
</blockquote>
<h2 id="downloading-and-unzipping-poolq">Downloading and Unzipping PoolQ</h2>
<p>You can download PoolQ from an as yet undetermined location. The file you download is a ZIP file that you will need to unzip. In most cases, this is as simple as right-clicking on the zip file, and selecting something like “extract contents” from the popup menu. This will create a new folder on your computer named <code>poolq-3.3.1</code>, with the following contents:</p>
<ul>
<li><code>poolq3.jar</code></li>
<li><code>poolq3.bat</code></li>
<li><code>poolq3.sh</code></li>
<li><code>test-data/</code></li>
</ul>
<p>Feel free to rename the folder, and to move it to wherever you want. Be aware, however, that the <code>.sh</code> and <code>.bat</code> files will only function properly if they can find the <code>poolq.jar</code> file in the same folder.</p>
<p>The test-data folder contains seven sets of sample input data and a Makefile that will run PoolQ on each set, printing the full command line in the process. If you have GNU Make installed, you can test all seven sample datasets by running:</p>
<pre><code>% cd test-data
% make</code></pre>
<p>You can also test them individually by running:</p>
<pre><code>% (cd test-data; make test-scenario1)
% (cd test-data; make test-scenario2)
% (cd test-data; make test-scenario3)
% (cd test-data; make test-scenario4)
% (cd test-data; make test-scenario5)
% (cd test-data; make test-scenario6)
% (cd test-data; make test-long-template)</code></pre>
<h2 id="recommended-jvm-settings">Recommended JVM Settings</h2>
<p>We recommend the following JVM settings be provided when running PoolQ:</p>
<ul>
<li><code>-Xmx4G</code></li>
<li><code>-XX:+UseG1GC</code></li>
</ul>
<p>This document contains a number of example command-lines for running PoolQ; however, we only list the full JVM options once, since typing the full command becomes unwieldy and the JVM options distract somewhat from the command-line arguments that are passed to PoolQ itself. You can copy and paste the full Java command from here:</p>
<blockquote>
<p><code>java -Xmx4G -XX:+UseG1GC -jar poolq3.jar</code></p>
</blockquote>
<h2 id="running-poolq-1">Running PoolQ</h2>
<p>You can run PoolQ from any Windows, Mac, or Linux machine, but it requires some understanding about how to launch programs from the command line on your given operating system.</p>
<ol type="1">
<li>Open a terminal window for your operating system</li>
<li>Change directories to the <code>poolq-3.3.1</code> directory</li>
</ol>
<ul>
<li>On Windows, run:</li>
</ul>
<blockquote>
<p><code>poolq3.bat</code></p>
</blockquote>
<ul>
<li>Or, on a UNIX-based machine, run:</li>
</ul>
<blockquote>
<p><code>./poolq3.sh</code></p>
</blockquote>
<ul>
<li>Or, on any machine, run:</li>
</ul>
<blockquote>
<p><code>java -jar poolq3.jar</code></p>
</blockquote>
<p>If you successfully launched PoolQ, you should see a usage message explaining all of the command-line options:</p>
<pre><code>poolq 3.3.1
Usage: poolq [options]

--row-reference &lt;file&gt;   reference file for row barcodes (i.e., constructs)
--col-reference &lt;file&gt;   reference file for column barcodes (i.e., conditions)
--umi-reference &lt;file&gt;
--global-reference &lt;file&gt;
--row-reads &lt;file&gt;       required if reads are split between two files
--col-reads &lt;file&gt;       required if reads are split between two files
--reads &lt;file&gt;           required if reads are contained in a single file
--row-matcher &lt;matcher&gt;  function used to match row barcodes against the row reference database
--col-matcher &lt;matcher&gt;  function used to match column barcodes against the column reference database
--count-ambiguous &lt;value&gt;
when true, counts ambiguous fuzzy matches for all potential row barcodes
--row-barcode-policy &lt;barcode-policy&gt;
--col-barcode-policy &lt;barcode-policy&gt;
--umi-barcode-policy &lt;barcode-policy&gt;
--quality &lt;file&gt;
--counts &lt;file&gt;
--normalized-counts &lt;file&gt;
--barcode-counts &lt;file&gt;
--scores &lt;file&gt;
--normalized-scores &lt;file&gt;
--barcode-scores &lt;file&gt;
--correlation &lt;file&gt;
--run-info &lt;file&gt;
--unexpected-sequence-threshold &lt;number&gt;
--unexpected-sequences &lt;file&gt;
--umi-quality &lt;file&gt;
--unexpected-sequence-cache &lt;cache-dir&gt;
--skip-unexpected-sequence-report &lt;value&gt;
--skip-short-reads
--always-count-col-barcodes
                         Count each column barcode regardless of whether a row barcode was found in the read
--compat                 Enable PoolQ 2.X compatibility mode
--gct                    Output counts in GCT format</code></pre>
<p>At this point, you are ready to run PoolQ, supplying file names and locations for the 3 file inputs and 2 or 3 file outputs. For example:</p>
<ul>
<li>On Windows, run:</li>
</ul>
<blockquote>
<p><code>poolq3.bat --reads reads.fastq --col-reference conditions.txt --row-reference reference.txt --row-barcode-policy PREFIX:CACCG@12 --col-barcode-policy FIXED:0</code></p>
</blockquote>
<ul>
<li>Or, on a UNIX-based machine, run:</li>
</ul>
<blockquote>
<p><code>./poolq3.sh --reads reads.fastq --col-reference conditions.txt --row-reference reference.txt --row-barcode-policy PREFIX:CACCG@12 --col-barcode-policy FIXED:0</code></p>
</blockquote>
<ul>
<li>Or, on any machine, run:</li>
</ul>
<blockquote>
<p><code>java -jar poolq3.jar --reads reads.fastq --col-reference conditions.txt --row-reference reference.txt --row-barcode-policy PREFIX:CACCG@12 --col-barcode-policy FIXED:0</code></p>
</blockquote>
<h2 id="the-scoring-algorithm">The Scoring Algorithm</h2>
<p>The reads file contains the sequencing reads. PoolQ supports any of the following formats:</p>
<ul>
<li>FASTQ (including Solexa/Illumina variants)</li>
<li>SAM</li>
<li>BAM</li>
</ul>
<p>Most often, the entire row barcode is included in the read. However, for files with very short read lengths the row barcode sequence may be truncated. In the case of truncated row barcode sequences, PoolQ will attempt to match based on the available row barcode sequence prefix.</p>
<p>If the read does not have a column barcode that is an exact match to a barcode found in the conditions file, then the line is not counted, except in the section of the quality report devoted to counting reads for barcodes not found in the conditions file.</p>
<h3 id="counting-reads-that-match-a-barcode">Counting Reads that Match a Barcode</h3>
<p>The PoolQ scoring algorithm always attempts to match barcodes exactly to to one of the sequences provided in the reference file first. If an exact match is found, then only the exact match is counted.</p>
<p>If an exact match is not found, PoolQ will attempt to match to a known allowing a single nucleotide mismatch. An N in the row barcode sequence is considered a single nucleotide mismatch. The exact match setting allows you to override the single nucleotide mismatch behavior and score only exact matches.</p>
<p>If a row barcode sequence is a single nucleotide mismatch to two or more different barcodes, PoolQ will discard the read by default. It is possible to override this behavior as well with the include ambiguous setting, in which case PoolQ counts the read for every row barcode sequence that is a single nucleotide mismatch.</p>
<p>If PoolQ matches a read to a column barcode that is mapped to a condition, and a row barcode that is mapped to one or more row barcode IDs, then the counts are incremented for all of the matching condition/row barcode ID pairs.</p>
<p>Row barcodes are counted as unexpected sequences if they are not successfully matched by the above procedure.</p>
<h2 id="contact-us">Contact Us</h2>
<p>Your feedback of any kind is much appreciated. Please email us at rnaiinformatics@broadinstitute.org.</p>
</body>
</html>
